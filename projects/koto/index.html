
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://osg-htc.org/collaboration-support/projects/koto/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.0">
    
    
      
        <title>KOTO - OSG Collaboration Support</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.33e2939f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#koto" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OSG Collaboration Support" class="md-header__button md-logo" aria-label="OSG Collaboration Support" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OSG Collaboration Support
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              KOTO
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OSG Collaboration Support" class="md-nav__button md-logo" aria-label="OSG Collaboration Support" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    OSG Collaboration Support
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../misc/services/" class="md-nav__link">
        Services
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../misc/onboard/" class="md-nav__link">
        Access to Collab AP
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      <label class="md-nav__link" for="__nav_4">
        Current Collaborations
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Current Collaborations" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Current Collaborations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../project-list/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Redtop/" class="md-nav__link">
        REDTOP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../icecube/" class="md-nav__link">
        IceCube
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../igwn/" class="md-nav__link">
        IGWN
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../lsst/" class="md-nav__link">
        LSST
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../spt/" class="md-nav__link">
        South Pole Telescope
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../veritas/" class="md-nav__link">
        VERITAS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../xenon/" class="md-nav__link">
        XENON
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gluex/" class="md-nav__link">
        GLUEX
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../clas12/" class="md-nav__link">
        GLAS12
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../moller/" class="md-nav__link">
        MOLLER
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../eic/" class="md-nav__link">
        EIC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../snowmass/" class="md-nav__link">
        Snowmass
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          KOTO
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        KOTO
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#koto" class="md-nav__link">
    KOTO
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-point" class="md-nav__link">
    Access Point
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-access" class="md-nav__link">
    Storage access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jobs-to-the-ospool" class="md-nav__link">
    Jobs to the OSPool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pegasus-workflows" class="md-nav__link">
    Pegasus Workflows
  </a>
  
    <nav class="md-nav" aria-label="Pegasus Workflows">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#koto-workflow-example" class="md-nav__link">
    KOTO workflow example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../misc/meeting-schedule/" class="md-nav__link">
        Meeting/Call schedule
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#koto" class="md-nav__link">
    KOTO
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-point" class="md-nav__link">
    Access Point
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-access" class="md-nav__link">
    Storage access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jobs-to-the-ospool" class="md-nav__link">
    Jobs to the OSPool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pegasus-workflows" class="md-nav__link">
    Pegasus Workflows
  </a>
  
    <nav class="md-nav" aria-label="Pegasus Workflows">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#koto-workflow-example" class="md-nav__link">
    KOTO workflow example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>KOTO</h1>
                
                <h2 id="koto">KOTO<a class="headerlink" href="#koto" title="Permanent link">&para;</a></h2>
<p>KOTO is an international collaboration of an experiment based at the JPARC HEP facility in Japan.</p>
<h2 id="access-point">Access Point<a class="headerlink" href="#access-point" title="Permanent link">&para;</a></h2>
<p>KOTO submits out of the Connect node: login.collab.ci-connect.net. To request an account, visit the portal at https://ci-connect.net and 
ask to join the <a href="https://www.ci-connect.net/groups/root.collab">PATh Collaborations</a> group. <a href="https://www.ci-connect.net/groups/root.collab.KOTO">KOTO</a> is a subgroup under PATh collaborations and a separate request needs to be made to join by clicking the request memberhip button.  </p>
<h2 id="storage-access">Storage access<a class="headerlink" href="#storage-access" title="Permanent link">&para;</a></h2>
<p>Besides their home directories on login.collab.ci-connect.net, users have access to local storage in /scratch/<user_id> and distributed storage in /collab/user/<user_id>. In addition, the collaboration has access to /collab/project/KOTO for sharing data products between the users. </p>
<p>The distributed storage is http accessible: http://stash.osgstorage.org/collab/KOTO and data can be downloaded using a browser or command line utilities like wget or curl.</p>
<h2 id="jobs-to-the-ospool">Jobs to the OSPool<a class="headerlink" href="#jobs-to-the-ospool" title="Permanent link">&para;</a></h2>
<p>Inlined below is a submit script to run a KOTO job on the OSPool</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">Universe</span> <span class="o">=</span> Vanilla
<span class="nv">Executable</span>     <span class="o">=</span> run_koto.sh
<span class="nv">Requirements</span> <span class="o">=</span> <span class="nv">HAS_SINGULARITY</span> <span class="o">==</span> TRUE
+SingularityImage <span class="o">=</span> <span class="s2">&quot;/cvmfs/singularity.opensciencegrid.org/ppaschos/koto-dev:latest&quot;</span>
<span class="nv">transfer_input_files</span> <span class="o">=</span> e14_201605.mac
<span class="nv">Error</span>   <span class="o">=</span> output.err.<span class="k">$(</span>Cluster<span class="k">)</span>-<span class="k">$(</span>Process<span class="k">)</span>
<span class="nv">Output</span>  <span class="o">=</span> output.out.<span class="k">$(</span>Cluster<span class="k">)</span>-<span class="k">$(</span>Process<span class="k">)</span>
<span class="nv">Log</span>     <span class="o">=</span> output.log.<span class="k">$(</span>Cluster<span class="k">)</span>
<span class="nv">should_transfer_files</span> <span class="o">=</span> YES
<span class="nv">WhenToTransferOutput</span> <span class="o">=</span> ON_EXIT
<span class="nv">request_cpus</span> <span class="o">=</span> <span class="m">1</span>
<span class="nv">request_memory</span> <span class="o">=</span> 2GB
<span class="nv">request_disk</span> <span class="o">=</span> 2GB
+ProjectName<span class="o">=</span><span class="s2">&quot;collab.KOTO&quot;</span>
Queue <span class="m">1</span>
</code></pre></div>
</td></tr></table>
<p>KOTO uses a software stack that is included in the Singularity image - shown in the script above. The image is deployed on the remote execution nodes and jobs run within the Singularity container. The input file, e14_201605.mac, is sent to the execution node as part of the job. The execution script, run_koto.sh, sets the environment and includes all invocations to executables. The following script, run_koto.sh, runs a benchmark example from the E14 library.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">echo</span> <span class="nv">$HOSTNAME</span>
<span class="nb">source</span> /opt/koto/root/v6.22.02/bin/thisroot.sh
<span class="nb">source</span> /opt/koto/geant4/10.05.p01/bin/geant4.sh
<span class="nb">echo</span> <span class="s2">&quot;PATH --&gt; &quot;</span> <span class="nv">$PATH</span>
<span class="nb">echo</span> <span class="s2">&quot;LD_LIBRARY_PATH --&gt; &quot;</span> <span class="nv">$LD_LIBRARY_PATH</span>
<span class="nb">echo</span> <span class="s2">&quot;ROOTSYS --&gt; &quot;</span> <span class="nv">$ROOTSYS</span>
<span class="nb">echo</span> <span class="s2">&quot;G4 data environent&quot;</span>
env <span class="p">|</span> grep G4
<span class="nb">export</span> <span class="nv">E14_TOP_DIR</span><span class="o">=</span><span class="s2">&quot;/opt/koto/e14/201605v6.2/e14&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;E14_TOP_DIR=&quot;</span> <span class="nv">$E14_TOP_DIR</span>
<span class="nb">source</span> /opt/koto/e14/201605v6.2/setup.sh
<span class="nv">output</span><span class="o">=</span><span class="s2">&quot;output.root&quot;</span>
<span class="nv">nevent</span><span class="o">=</span><span class="m">1000</span>
<span class="nv">seed</span><span class="o">=</span><span class="m">0</span>
<span class="nb">echo</span> <span class="s2">&quot;Running Code&quot;</span>
/opt/koto/e14/201605v6.2/e14/examples/gsim4test/bin/gsim4test e14_201605.mac <span class="si">${</span><span class="nv">output</span><span class="si">}</span> <span class="si">${</span><span class="nv">nevent</span><span class="si">}</span> <span class="si">${</span><span class="nv">seed</span><span class="si">}</span> <span class="si">${</span><span class="nv">seed</span><span class="si">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="pegasus-workflows">Pegasus Workflows<a class="headerlink" href="#pegasus-workflows" title="Permanent link">&para;</a></h2>
<p><a href="https://pegasus.isi.edu">The Pegasus project</a> encompasses a set
of technologies that help workflow-based applications execute in a
number of different environments including desktops, campus clusters,
grids, and clouds. Pegasus bridges the scientific domain and the
execution environment by automatically mapping high-level workflow
descriptions onto distributed resources. It automatically locates the
necessary input data and computational resources necessary for workflow
execution. Pegasus enables scientists to construct workflows in abstract
terms without worrying about the details of the underlying execution
environment or the particulars of the low-level specifications required
by the middleware. Some of the advantages of using Pegasus include:</p>
<ul>
<li>
<p><strong>Portability / Reuse</strong> - User created workflows can easily be
     run in different environments without alteration. Pegasus currently
     runs workflows on compute systems scheduled via HTCondor, including the
     OSPool, and other other systems or via other schedulers (e.g. ACCESS
     resources, Amazon EC2, Google Cloud, and many campus clusters). The same
     workflow can run on a single system or across a heterogeneous set of
     resources.</p>
</li>
<li>
<p><strong>Performance</strong> - The Pegasus mapper can reorder, group, and prioritize
     tasks in order to increase the overall workflow performance.</p>
</li>
<li>
<p><strong>Scalability</strong> - Pegasus can easily scale both the size of the
     workflow, and the resources that the workflow is distributed over.
     Pegasus runs workflows ranging from just a few computational tasks up
     to 1 million tasks. The number of resources involved in executing a
     workflow can scale as needed without any impediments to performance.</p>
</li>
<li>
<p><strong>Provenance</strong> - By default, all jobs in Pegasus are launched via
     the kickstart process that captures runtime provenance of the job and
     helps in debugging. The provenance data is collected in a database, and
     the data can be summarized with tools such as pegasus-statistics or
     directly with SQL queries.</p>
</li>
<li>
<p><strong>Data Management</strong> - Pegasus handles replica selection, data
     transfers and output registrations in data catalogs. These tasks are
     added to a workflow as auxiliary jobs by the Pegasus planner.</p>
</li>
<li>
<p><strong>Reliability</strong> - Jobs and data transfers are automatically retried
     in case of failures. Debugging tools such as pegasus-analyzer help the
     user to debug the workflow in case of non-recoverable failures.</p>
</li>
<li>
<p><strong>Error Recovery</strong> - When errors occur, Pegasus tries to recover
     when possible by retrying tasks, retrying the entire workflow, providing
     workflow-level checkpointing, re-mapping portions of the workflow,
     trying alternative data sources for staging data, and, when all else
     fails, providing a rescue workflow containing a description of only the
     work that remains to be done. Pegasus keeps track of what has been done
     (provenance) including the locations of data used and produced, and
     which software was used with which parameters.</p>
</li>
</ul>
<p>OSG has no read/write enabled shared file system across the resources.
Jobs are required to either bring inputs along with the job, or as
part of the job stage the inputs from a remote location. The following
examples highlight how Pegasus can be used to manage KOTO workloads in
such an environment by providing an abstraction layer around things
like data movements and job retries, enabling the users to run larger
workloads, spending less time developing job management tools and
babysitting their computations.</p>
<p>Pegasus workflows have 4 components:</p>
<ol>
<li>
<p><strong>Site Catalog</strong> - Describes the execution environment in which
     the workflow will be executed.</p>
</li>
<li>
<p><strong>Transformation Catalog</strong> - Specifies locations of the executables
     used by the workflow.</p>
</li>
<li>
<p><strong>Replica Catalog</strong> - Specifies locations of the input data to the
     workflow.</p>
</li>
<li>
<p><strong>Workflow Description</strong> - An abstract workflow description
     containing compute steps and dependencies between the steps. We
     refer to this workflow as abstract because it does not contain data
     locations and available software.</p>
</li>
</ol>
<p>When developing a Pegasus Workflow using the
<a href="https://pegasus.isi.edu/documentation/reference-guide/api-reference.html">Python API</a>,
all four components may be defined in the same file.</p>
<p>For details, please refer to the <a href="https://pegasus.isi.edu/documentation/">Pegasus documentation</a>.</p>
<h3 id="koto-workflow-example">KOTO workflow example<a class="headerlink" href="#koto-workflow-example" title="Permanent link">&para;</a></h3>
<p>The GitHub repo <a href="https://github.com/pegasus-isi/koto-pegasus">https://github.com/pegasus-isi/koto-pegasus</a>
contains a sample Pegasus workflow for KOTO processing. It is a very
simple Monte Carlo example, containing just N independent jobs:</p>
<p><img alt="fig 1" src="https://raw.githubusercontent.com/pegasus-isi/koto-pegasus/master/figures/KOTO-Workflow.png" /></p>
<p>This example is using <a href="https://derekweitzel.com/2018/09/26/stashcache-by-the-numbers/">OSG StashCache</a>
for data transfers. Credentials are transparant to the end users.</p>
<p>Additionally, this example uses a custom container to run jobs. This
ensures a consistent and complete environment for the jobs. Which 
container to use is defined in <code>workflow.py</code> with the
<code>+SingularityImage</code> attribute.</p>
<p>When invoked, the workflow script (<code>workflow.py</code>) does the following:</p>
<ol>
<li>
<p>Writes the file <code>pegasus.properties</code>. This file contains configuration settings
     used by Pegasus and HTCondor.</p>
<div class="codehilite"><pre><span></span><code> # --- Properties ---------------------------------------------------------------
 props = Properties()
 props[&quot;pegasus.data.configuration&quot;] = &quot;nonsharedfs&quot;

 # Provide a full kickstart record, including the environment, even for successful jobs
 props[&quot;pegasus.gridstart.arguments&quot;] = &quot;-f&quot;

 # Limit the number of idle jobs for large workflows
 props[&quot;dagman.maxidle&quot;] = &quot;1000&quot;

 # use timestamps for all our dirs - this make sure we have unique names in stash
 props[&quot;pegasus.dir.useTimestamp&quot;] = &quot;true&quot;

 # seperate output dir for each workflow run
 props[&quot;pegasus.dir.storage.deep&quot;] = &quot;true&quot;

 # Help Pegasus developers by sharing performance data (optional)
 props[&quot;pegasus.monitord.encoding&quot;] = &quot;json&quot;
 props[&quot;pegasus.catalog.workflow.amqp.url&quot;] = &quot;amqp://friend:donatedata@msgs.pegasus.isi.edu:5672/prod/workflows&quot;
 props[&quot;pegasus.metrics.app&quot;] = &quot;KOTO&quot;
</code></pre></div>

</li>
<li>
<p>Writes the file <code>sites.yml</code>. This file describes the execution environment in
     which the workflow will be run.</p>
<div class="codehilite"><pre><span></span><code> # --- Sites --------------------------------------------------------------------
 sc = SiteCatalog()

 # local site (submit machine)
 local_site = Site(name=&quot;local&quot;)

 local_shared_scratch = Directory(directory_type=Directory.SHARED_SCRATCH, path=WORK_DIR / &quot;scratch&quot;)
 local_shared_scratch.add_file_servers(FileServer(url=&quot;file://&quot; + str(WORK_DIR / &quot;scratch&quot;), operation_type=Operation.ALL))
 local_site.add_directories(local_shared_scratch)

 local_storage = Directory(directory_type=Directory.LOCAL_STORAGE, path=WORK_DIR / &quot;outputs&quot;)
 local_storage.add_file_servers(FileServer(url=&quot;file://&quot; + str(WORK_DIR / &quot;outputs&quot;), operation_type=Operation.ALL))
 local_site.add_directories(local_storage)

 local_site.add_env(PATH=os.environ[&quot;PATH&quot;])
 sc.add_sites(local_site)

 # stash site (staging site, where intermediate data will be stored)
 stash_site = Site(name=&quot;stash&quot;, arch=Arch.X86_64, os_type=OS.LINUX)
 stash_staging_path = &quot;/collab/user/{USER}/staging&quot;.format(USER=getpass.getuser())
 stash_shared_scratch = Directory(directory_type=Directory.SHARED_SCRATCH, path=stash_staging_path)
 stash_shared_scratch.add_file_servers(
     FileServer(
         url=&quot;stash:///osgconnect{STASH_STAGING_PATH}&quot;.format(STASH_STAGING_PATH=stash_staging_path), 
         operation_type=Operation.ALL)
 )
 stash_site.add_directories(stash_shared_scratch)
 sc.add_sites(stash_site)

 # condorpool (execution site)
 condorpool_site = Site(name=&quot;condorpool&quot;, arch=Arch.X86_64, os_type=OS.LINUX)
 condorpool_site.add_pegasus_profile(style=&quot;condor&quot;)
 condorpool_site.add_condor_profile(
     universe=&quot;vanilla&quot;,
     requirements=&quot;HAS_SINGULARITY == True &amp;&amp; HAS_AVX2 == True&quot;,
     request_cpus=1,
     request_memory=&quot;4 GB&quot;,
     request_disk=&quot;10 GB&quot;,
 )
 condorpool_site.add_profiles(
     Namespace.CONDOR, 
     key=&quot;+SingularityImage&quot;, 
     value=&#39;&quot;/cvmfs/singularity.opensciencegrid.org/chiehlin0212/koto-dev:latest&quot;&#39;
 )
 condorpool_site.add_profiles(
     Namespace.CONDOR, 
     key=&quot;+ProjectName&quot;, 
     value=&#39;&quot;collab.KOTO&quot;&#39;
 )

 sc.add_sites(condorpool_site)

 # write SiteCatalog to ./sites.yml
 sc.write()
</code></pre></div>

</li>
<li>
<p>Writes the file <code>transformations.yml</code>. This file specifies the executables used
     in the workflow and contains the locations where they are physically located.
     In this example, we only have <code>run_koto.sh</code>.</p>
<div class="codehilite"><pre><span></span><code> # --- Transformations ----------------------------------------------------------
 run_koto = Transformation(
                name=&quot;run_koto&quot;,
                site=&quot;local&quot;,
                pfn=TOP_DIR / &quot;bin/run_koto.sh&quot;,
                is_stageable=True
            ).add_pegasus_profile(clusters_size=1)

 tc = TransformationCatalog()
 tc.add_transformations(run_koto)

 # write TransformationCatalog to ./transformations.yml
 tc.write()
</code></pre></div>

</li>
<li>
<p>Writes the file <code>replicas.yml</code>. This file specifies the physical locations of
     any input files used by the workflow. In this example, there is an entry for
     each file in the <code>inputs/</code> directory, and all files matching
     <code>/collab/project/KOTO/external/run87/accidental/64kW/**/*.root</code></p>
<div class="codehilite"><pre><span></span><code> # --- Replicas -----------------------------------------------------------------

 rc = ReplicaCatalog()

 input_files = []

 # all files in the inputs/ dir
 input_files = glob.glob(str(TOP_DIR / &quot;inputs/*&quot;))

 for f in input_files:
     lfn = os.path.basename(f)    
     rc.add_replica(site=&quot;local&quot;, lfn=lfn, pfn=f)

 # also add all wave files
 wave_files = glob.glob(&quot;/collab/project/KOTO/external/run87/accidental/64kW/**/*.root&quot;, recursive=True)

 for f in wave_files:
     lfn = os.path.basename(f)    
     rc.add_replica(site=&quot;local&quot;, lfn=lfn, pfn=f)

 # write ReplicaCatalog to replicas.yml
 rc.write()
</code></pre></div>

</li>
<li>
<p>Builds the wordfreq workflow and submits it for execution. When <code>wf.plan</code> is
     invoked, <code>pegasus.properties</code>, <code>sites.yml</code>, <code>transformations.yml</code>, and
     <code>replicas.yml</code> will be consumed as part of the workflow planning process. Note that
     in this step there is no mention of data movement and job details as these are
     added by Pegasus when the workflow is planned into an executable workflow. As
     part of the planning process, additional jobs which handle scratch directory
     creation, data staging, and data cleanup are added to the workflow.</p>
<div class="codehilite"><pre><span></span><code> # --- Workflow -----------------------------------------------------------------
 wf = Workflow(name=&quot;koto&quot;)

 random.seed()
 for n in range(10):

     # arguments
     decay_mode = &quot;KL3pi0&quot;
     seed = str(random.randint(0, 10000))
     wave = os.path.basename(random.choice(wave_files))

     # TODO: check if we already have a job with the seed/wave combination
     print(&quot; ... added mc job with wave={} / seed={}&quot;.format(wave, seed))

     out_root = File(&quot;{}_BasicVetoAndCuts_Accidental_{}.root&quot;.format(decay_mode, seed))
     job = Job(run_koto)\
              .add_args(decay_mode, seed, wave)\
              .add_outputs(out_root)

     # inputs, only use the lfn
     for inp in input_files + [wave]:
         job.add_inputs(os.path.basename(inp))

     wf.add_jobs(job)

 # plan and run the workflow
 wf.plan(
     dir=WORK_DIR / &quot;runs&quot;,
     sites=[&quot;condorpool&quot;],
     staging_sites={&quot;condorpool&quot;: &quot;stash&quot;},
     output_sites=[&quot;local&quot;],
     cluster=[&quot;horizontal&quot;],
     submit=True
 )
</code></pre></div>

</li>
</ol>
<p>Submit the workflow by executing <code>workflow.py</code>.</p>
<div class="codehilite"><pre><span></span><code>$ ./workflow.py
</code></pre></div>

<p>Note that when Pegasus plans/submits a workflow, a workflow directory is created
and presented in the output. In the following example output, the workflow directory
is <code>/home/user/workflows/runs/pegasus/run0014</code>.</p>
<div class="codehilite"><pre><span></span><code>2020.12.18 14:33:07.059 CST:   -----------------------------------------------------------------------
2020.12.18 14:33:07.064 CST:   File for submitting this DAG to HTCondor           : koto-workflow-0.dag.condor.sub
2020.12.18 14:33:07.070 CST:   Log of DAGMan debugging messages                 : koto-workflow-0.dag.dagman.out
2020.12.18 14:33:07.075 CST:   Log of HTCondor library output                     : koto-workflow-0.dag.lib.out
2020.12.18 14:33:07.080 CST:   Log of HTCondor library error messages             : koto-workflow-0.dag.lib.err
2020.12.18 14:33:07.086 CST:   Log of the life of condor_dagman itself          : koto-workflow-0.dag.dagman.log
2020.12.18 14:33:07.091 CST:
2020.12.18 14:33:07.096 CST:   -no_submit given, not submitting DAG to HTCondor.  You can do this with:
2020.12.18 14:33:07.107 CST:   -----------------------------------------------------------------------
2020.12.18 14:33:11.352 CST:   Your database is compatible with Pegasus version: 5.1.0dev
[WARNING]  Submitting to condor koto-workflow-0.dag.condor.sub
2020.12.18 14:33:12.060 CST:   Time taken to execute is 5.818 seconds

Your workflow has been started and is running in the base directory:

/home/user/workflows/runs/koto-workflow/run0014

*** To monitor the workflow you can run ***

pegasus-status -l /home/user/workflows/runs/koto-workflow/run0014


*** To remove your workflow run ***

pegasus-remove /home/user/workflows/runs/koto-workflow/run0014
</code></pre></div>

<p>This directory is the handle to the workflow instance
and is used by Pegasus command line tools. Some useful tools to know about:</p>
<ul>
<li><code>pegasus-status -v [wfdir]</code>
     Provides status on a currently running workflow. (<a href="https://pegasus.isi.edu/documentation/manpages/pegasus-status.html">more</a>)</li>
<li><code>pegasus-analyzer [wfdir]</code>
     Provides debugging clues why a workflow failed. Run this after a workflow has failed. (<a href="https://pegasus.isi.edu/documentation/manpages/pegasus-analyzer.html">more</a>)</li>
<li><code>pegasus-statistics [wfdir]</code>
     Provides statistics, such as walltimes, on a workflow after it has completed. (<a href="https://pegasus.isi.edu/documentation/manpages/pegasus-statistics.html">more</a>)</li>
<li><code>pegasus-remove [wfdir]</code>
     Removes a workflow from the system. (<a href="https://pegasus.isi.edu/documentation/manpages/pegasus-remove.html">more</a>) </li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../snowmass/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Snowmass
            </div>
          </div>
        </a>
      
      
        <a href="../../misc/meeting-schedule/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Meeting/Call schedule
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.tabs.link"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.d892486b.min.js"></script>
      
    
  </body>
</html>